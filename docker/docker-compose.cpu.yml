services:
  gemma_service:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile
    image: gemma-voice-api
    container_name: gemma_service
    restart: always
    # NO GPU configuration for CPU-only mode
    volumes:
      - ~/.cache/huggingface:/home/appuser/.cache/huggingface
      - ~/.cache/whisper:/home/appuser/.cache/whisper
    environment:
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
      - ENABLE_FASTER_WHISPER=${ENABLE_FASTER_WHISPER:-true}
      - FASTER_WHISPER_MODEL_SIZE=${FASTER_WHISPER_MODEL_SIZE:-base}
      - FASTER_WHISPER_DEVICE=${FASTER_WHISPER_DEVICE:-cpu}  # CPU mode
      - FASTER_WHISPER_COMPUTE_TYPE=${FASTER_WHISPER_COMPUTE_TYPE:-int8}  # Optimized for CPU
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - REQUEST_ID_HEADER=${REQUEST_ID_HEADER:-X-Request-ID}
      - API_KEY_ENABLED=${API_KEY_ENABLED:-false}
      - API_KEY_HEADER_NAME=${API_KEY_HEADER_NAME:-X-API-Key}
      - API_KEYS=${API_KEYS:-}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-false}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-120}
      - RATE_LIMIT_WINDOW_SECONDS=${RATE_LIMIT_WINDOW_SECONDS:-60}
      - RATE_LIMIT_BURST_MULTIPLIER=${RATE_LIMIT_BURST_MULTIPLIER:-1.0}
      - OPENAUDIO_API_KEY=${OPENAUDIO_API_KEY:-}
      - OPENAUDIO_API_BASE=${OPENAUDIO_API_BASE:-http://openaudio_api:21251}
      - OPENAUDIO_TTS_PATH=${OPENAUDIO_TTS_PATH:-/v1/tts}
      - OPENAUDIO_DEFAULT_FORMAT=${OPENAUDIO_DEFAULT_FORMAT:-wav}
      - OPENAUDIO_DEFAULT_REFERENCE_ID=${OPENAUDIO_DEFAULT_REFERENCE_ID:-}
      - OPENAUDIO_DEFAULT_NORMALIZE=${OPENAUDIO_DEFAULT_NORMALIZE:-true}
      - OPENAUDIO_TIMEOUT_SECONDS=${OPENAUDIO_TIMEOUT_SECONDS:-120}
      - OPENAUDIO_MAX_RETRIES=${OPENAUDIO_MAX_RETRIES:-3}
    ports:
      - "21250:6666"
    depends_on:
      - openaudio_api
    networks:
      - shared_services_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6666/health"]
      interval: 15s
      timeout: 10s
      retries: 5

  openaudio_api:
    image: fishaudio/fish-speech:server-cpu
    container_name: openaudio_api
    restart: unless-stopped
    volumes:
      - ../backend/openaudio-checkpoints:/app/checkpoints:ro
      - openaudio-references:/app/references
    environment:
      - API_SERVER_NAME=0.0.0.0
      - API_SERVER_PORT=21251
    # NO GPU configuration for CPU-only mode
    networks:
      - shared_services_network
    ports:
      - "21251:21251"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21251/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  openaudio_webui:
    image: fishaudio/fish-speech:server-cpu
    container_name: openaudio_webui
    restart: unless-stopped
    depends_on:
      - openaudio_api
    volumes:
      - ../backend/openaudio-checkpoints:/app/checkpoints:ro
      - openaudio-references:/app/references
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
    command:
      [
        "python3",
        "-m",
        "tools.run_webui",
        "--llama-checkpoint-path",
        "checkpoints/OpenAudio-S1-mini",
        "--decoder-checkpoint-path",
        "checkpoints/OpenAudio-S1-mini/codec.pth",
        "--decoder-config-name",
        "modded_dac_vq",
      ]
    networks:
      - shared_services_network
    ports:
      - "27860:7860"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

networks:
  shared_services_network:
    external: true

volumes:
  openaudio-references:
    driver: local
