services:
  gemma_service:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile
    image: gemma-voice-api
    container_name: gemma_service
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    volumes:
      - ~/.cache/huggingface:/home/appuser/.cache/huggingface
      - ~/.cache/whisper:/home/appuser/.cache/whisper
    environment:
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
      - ENABLE_FASTER_WHISPER=false
      - OPENAI_API_BASE=http://whisper_service:8000/v1
      - OPENAI_API_KEY=dummy-key
      # Options: Systran/faster-whisper-small (~500MB, fast), Systran/faster-whisper-medium (~1.5GB), deepdml/faster-whisper-large-v3-turbo-ct2 (~1.5GB, best quality+speed)
      - OPENAI_WHISPER_MODEL=${OPENAI_WHISPER_MODEL:-Systran/faster-whisper-small}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - REQUEST_ID_HEADER=${REQUEST_ID_HEADER:-X-Request-ID}
      - API_KEY_ENABLED=${API_KEY_ENABLED:-false}
      - API_KEY_HEADER_NAME=${API_KEY_HEADER_NAME:-X-API-Key}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-false}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-120}
      - RATE_LIMIT_WINDOW_SECONDS=${RATE_LIMIT_WINDOW_SECONDS:-60}
      - RATE_LIMIT_BURST_MULTIPLIER=${RATE_LIMIT_BURST_MULTIPLIER:-1.0}
      - OPENAUDIO_API_KEY=${OPENAUDIO_API_KEY:-}
      - OPENAUDIO_API_BASE=${OPENAUDIO_API_BASE:-http://openaudio_api:21251}
      - OPENAUDIO_TTS_PATH=${OPENAUDIO_TTS_PATH:-/v1/tts}
      - OPENAUDIO_DEFAULT_FORMAT=${OPENAUDIO_DEFAULT_FORMAT:-wav}
      - OPENAUDIO_DEFAULT_REFERENCE_ID=${OPENAUDIO_DEFAULT_REFERENCE_ID:-}
      - OPENAUDIO_DEFAULT_NORMALIZE=${OPENAUDIO_DEFAULT_NORMALIZE:-true}
      - OPENAUDIO_TIMEOUT_SECONDS=${OPENAUDIO_TIMEOUT_SECONDS:-120}
      - OPENAUDIO_MAX_RETRIES=${OPENAUDIO_MAX_RETRIES:-3}
      # LiveKit configuration
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://livekit:7880}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - LIVEKIT_ROOM_NAME=${LIVEKIT_ROOM_NAME:-gemma-voice-room}
    # Expose the port to the host machine for direct testing/access
    ports:
      - "21250:6666"
    depends_on:
      - openaudio_api
      - whisper_service
      - livekit
    networks:
      # Connect this service to our shared network
      - shared_services_network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6666/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  whisper_service:
    image: fedirz/faster-whisper-server:latest-cuda
    container_name: whisper_service
    restart: unless-stopped
    environment:
      - WHISPER_MODEL=base
      - WHISPER_COMPUTE_TYPE=float16
      - WHISPER_DEVICE=cuda
    volumes:
      - ~/.cache/huggingface:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    networks:
      - shared_services_network
    ports:
      - "21252:8000"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  openaudio_api:
    image: fishaudio/fish-speech:server-cuda
    container_name: openaudio_api
    restart: unless-stopped
    volumes:
      - ../backend/openaudio-checkpoints:/app/checkpoints:ro
      - openaudio-references:/app/references
    environment:
      - COMPILE=1
      - API_SERVER_NAME=0.0.0.0
      - API_SERVER_PORT=21251
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    networks:
      - shared_services_network
    ports:
      - "21251:21251"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:21251/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit
    restart: unless-stopped
    command: --config /etc/livekit.yaml
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml:ro
    environment:
      - LIVEKIT_KEYS=${LIVEKIT_API_KEY:-devkey}: ${LIVEKIT_API_SECRET:-secret}
    networks:
      - shared_services_network
    ports:
      - "21254:7880"   # HTTP/WebSocket
      - "21255:7881"   # RTC over TCP
      - "21256:7882/udp"  # RTC over UDP
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:7880" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: ../frontend
      dockerfile: ../docker/frontend.Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:21250}
        VITE_API_KEY: ${VITE_API_KEY:-}
    image: gemma-voice-frontend
    container_name: gemma_frontend
    restart: unless-stopped
    depends_on:
      gemma_service:
        condition: service_healthy
    ports:
      - "21253:80"
    networks:
      - shared_services_network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  # Declare that the network is external and has been created manually
  shared_services_network:
    external: true

volumes:
  openaudio-references:
    driver: local
